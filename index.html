<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>g-commit — генератор Conventional Commits по git diff --staged</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root { color-scheme: dark; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .glass { background: rgba(15, 23, 42, .72); backdrop-filter: blur(10px); }
    .scrollbar-thin::-webkit-scrollbar{height:10px;width:10px}
    .scrollbar-thin::-webkit-scrollbar-thumb{background:#334155;border-radius:999px}
    .scrollbar-thin::-webkit-scrollbar-track{background:#0b1220}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="relative overflow-hidden border-b border-slate-800">
    <div class="absolute inset-0 opacity-60 pointer-events-none" aria-hidden="true">
      <div class="absolute -top-40 -left-40 w-[520px] h-[520px] bg-indigo-600/30 blur-3xl rounded-full"></div>
      <div class="absolute -bottom-52 -right-52 w-[620px] h-[620px] bg-cyan-500/20 blur-3xl rounded-full"></div>
    </div>

    <div class="relative max-w-6xl mx-auto px-4 py-8">
      <div class="flex flex-col gap-3">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-cyan-400 shadow-soft"></div>
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">g-commit</h1>
            <p class="text-slate-300 text-sm md:text-base">Автоматически генерирует лаконичное сообщение коммита по Conventional Commits на основе <span class="mono">git diff --staged</span>.</p>
          </div>
        </div>

        <div class="flex flex-col md:flex-row md:items-center gap-2 text-sm">
          <div class="inline-flex items-center gap-2 bg-slate-900/60 border border-slate-800 rounded-xl px-3 py-2">
            <span class="text-slate-400">Шаги:</span>
            <ol class="flex flex-wrap gap-2">
              <li class="inline-flex items-center gap-2"><span class="px-2 py-0.5 rounded-lg bg-slate-800 text-slate-200">1</span><span class="mono">git diff --staged</span></li>
              <li class="inline-flex items-center gap-2"><span class="px-2 py-0.5 rounded-lg bg-slate-800 text-slate-200">2</span>вставьте diff</li>
              <li class="inline-flex items-center gap-2"><span class="px-2 py-0.5 rounded-lg bg-slate-800 text-slate-200">3</span>скопируйте commit message</li>
            </ol>
          </div>

          <div class="md:ml-auto flex flex-wrap gap-2">
            <a class="text-slate-300 hover:text-white underline underline-offset-4" href="https://www.conventionalcommits.org/" target="_blank" rel="noreferrer">Спецификация Conventional Commits</a>
            <span class="text-slate-600">•</span>
            <button id="loadExampleBtn" class="text-slate-300 hover:text-white underline underline-offset-4" type="button">Загрузить пример diff</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Left: diff input + analysis -->
      <section class="glass border border-slate-800 rounded-2xl p-4 md:p-5 shadow-soft">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Ввод diff</h2>
            <p class="text-sm text-slate-300">Вставьте вывод <span class="mono">git diff --staged</span> (или части). Анализ выполняется локально в браузере.</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="analyzeBtn" type="button" class="px-3 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-400 text-slate-950 font-semibold">Проанализировать</button>
            <button id="clearBtn" type="button" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-100">Очистить</button>
          </div>
        </div>

        <div class="mt-4">
          <textarea id="diffInput" class="w-full h-56 md:h-72 rounded-xl bg-slate-950/70 border border-slate-800 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none p-3 mono text-sm leading-relaxed scrollbar-thin" placeholder="$ git diff --staged\n\ndiff --git a/src/app.ts b/src/app.ts\nindex ..."></textarea>
          <div class="mt-2 flex flex-col md:flex-row md:items-center justify-between gap-2 text-xs text-slate-400">
            <div>
              <span class="font-medium text-slate-300">Подсказка:</span> Ctrl/⌘ + Enter — «Проанализировать», Ctrl/⌘ + K — очистить.
            </div>
            <div id="diffHint" class="text-slate-500"></div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="border border-slate-800 rounded-2xl p-4 bg-slate-950/40">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Сводка</h3>
              <span id="analysisStatus" class="text-xs text-slate-400">ожидание</span>
            </div>
            <dl class="mt-3 grid grid-cols-2 gap-3 text-sm">
              <div>
                <dt class="text-slate-400">Файлы</dt>
                <dd id="filesCount" class="font-semibold">—</dd>
              </div>
              <div>
                <dt class="text-slate-400">Строки</dt>
                <dd class="font-semibold"><span class="text-emerald-300" id="additions">+0</span> <span class="text-rose-300" id="deletions">-0</span></dd>
              </div>
              <div class="col-span-2">
                <dt class="text-slate-400">Предположительный тип</dt>
                <dd class="mt-1 font-semibold" id="guessedType">—</dd>
              </div>
              <div class="col-span-2">
                <dt class="text-slate-400">Сферы (scopes)</dt>
                <dd class="mt-1" id="scopeChips">—</dd>
              </div>
            </dl>
          </div>

          <div class="border border-slate-800 rounded-2xl p-4 bg-slate-950/40">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Изменённые файлы</h3>
              <button id="toggleFilesBtn" type="button" class="text-xs text-slate-300 hover:text-white underline underline-offset-4">скрыть</button>
            </div>
            <div id="filesList" class="mt-3 max-h-52 overflow-auto scrollbar-thin pr-1">
              <p class="text-sm text-slate-400">Пока пусто — вставьте diff и нажмите «Проанализировать».</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Right: commit builder -->
      <section class="glass border border-slate-800 rounded-2xl p-4 md:p-5 shadow-soft">
        <div class="flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Генератор commit message</h2>
            <p class="text-sm text-slate-300">Отредактируйте тип/сферу/описание — предпросмотр обновляется автоматически.</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="copyBtn" type="button" class="px-3 py-2 rounded-xl bg-cyan-400 hover:bg-cyan-300 text-slate-950 font-semibold">Копировать</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="text-sm text-slate-300" for="typeSelect">Тип</label>
            <select id="typeSelect" class="mt-1 w-full rounded-xl bg-slate-950/70 border border-slate-800 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none p-2">
              <option value="feat">feat — новая функциональность</option>
              <option value="fix">fix — исправление бага</option>
              <option value="docs">docs — документация</option>
              <option value="style">style — форматирование/пробелы (без изменения логики)</option>
              <option value="refactor">refactor — рефакторинг</option>
              <option value="perf">perf — улучшение производительности</option>
              <option value="test">test — тесты</option>
              <option value="build">build — сборка/зависимости</option>
              <option value="ci">ci — CI конфигурация/скрипты</option>
              <option value="chore">chore — рутина/инфраструктурные изменения</option>
              <option value="revert">revert — откат</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-slate-300" for="scopeInput">Scope (опционально)</label>
            <input id="scopeInput" type="text" class="mt-1 w-full rounded-xl bg-slate-950/70 border border-slate-800 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none p-2 mono" placeholder="например: auth" />
            <div class="mt-2 flex flex-wrap gap-2" id="scopeSuggestions"></div>
          </div>

          <div class="md:col-span-2">
            <label class="text-sm text-slate-300" for="descriptionInput">Краткое описание (imperative)</label>
            <input id="descriptionInput" type="text" class="mt-1 w-full rounded-xl bg-slate-950/70 border border-slate-800 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none p-2" placeholder="например: improve login error handling" />
            <div class="mt-2 text-xs text-slate-400 flex flex-col md:flex-row md:items-center justify-between gap-2">
              <div id="headerLint">—</div>
              <div class="text-slate-500">Рекомендуемая длина заголовка: ≤ 72 символов.</div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="flex items-center justify-between gap-3">
              <label class="text-sm text-slate-300" for="bodyInput">Тело сообщения (опционально)</label>
              <button id="toggleBodyBtn" type="button" class="text-xs text-slate-300 hover:text-white underline underline-offset-4">показать</button>
            </div>
            <textarea id="bodyInput" class="hidden mt-1 w-full h-24 rounded-xl bg-slate-950/70 border border-slate-800 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none p-3 mono text-sm leading-relaxed scrollbar-thin" placeholder="Почему и что изменилось (опционально)"></textarea>
          </div>

          <div class="md:col-span-2 border border-slate-800 rounded-2xl p-4 bg-slate-950/40">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
              <label class="inline-flex items-center gap-2">
                <input id="breakingCheck" type="checkbox" class="accent-rose-400" />
                <span class="text-sm text-slate-200 font-medium">Breaking change</span>
              </label>
              <span class="text-xs text-slate-400">Добавляет <span class="mono">!</span> и footer <span class="mono">BREAKING CHANGE:</span></span>
            </div>
            <div id="breakingBox" class="mt-3 hidden">
              <label class="text-sm text-slate-300" for="breakingInput">Описание breaking change</label>
              <input id="breakingInput" type="text" class="mt-1 w-full rounded-xl bg-slate-950/70 border border-slate-800 focus:border-rose-400 focus:ring-2 focus:ring-rose-400/30 outline-none p-2" placeholder="например: remove legacy auth token format" />
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="flex items-center justify-between gap-3">
              <label class="text-sm text-slate-300" for="footerInput">Footer (опционально)</label>
              <button id="toggleFooterBtn" type="button" class="text-xs text-slate-300 hover:text-white underline underline-offset-4">показать</button>
            </div>
            <textarea id="footerInput" class="hidden mt-1 w-full h-20 rounded-xl bg-slate-950/70 border border-slate-800 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-400/30 outline-none p-3 mono text-sm leading-relaxed scrollbar-thin" placeholder="например: Refs: #123\nCo-authored-by: ..."></textarea>
          </div>
        </div>

        <div class="mt-5">
          <div class="flex items-center justify-between gap-3">
            <h3 class="font-semibold">Предпросмотр</h3>
            <div class="flex items-center gap-2">
              <span id="copyStatus" class="text-xs text-slate-400"></span>
            </div>
          </div>
          <pre id="preview" class="mt-2 p-4 rounded-2xl bg-slate-950/70 border border-slate-800 mono text-sm leading-relaxed overflow-auto max-h-64 scrollbar-thin"></pre>
        </div>
      </section>
    </div>

    <section class="mt-6 border border-slate-800 rounded-2xl p-4 bg-slate-950/40">
      <h2 class="font-semibold">Почему сообщение может быть «неидеальным»?</h2>
      <p class="mt-2 text-sm text-slate-300">Этот генератор не выполняет команды Git и не знает контекст вашей задачи — он лишь анализирует текст diff и применяет эвристики для выбора <span class="mono">type</span>/<span class="mono">scope</span>. Проверьте заголовок перед коммитом.</p>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 pb-10 pt-2 text-xs text-slate-500">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-2">
      <div>Локальная обработка в браузере • Ничего не отправляется на сервер</div>
      <div class="mono">g-commit</div>
    </div>
  </footer>

  <script>
    const el = (id) => document.getElementById(id);

    const diffInput = el('diffInput');
    const analyzeBtn = el('analyzeBtn');
    const clearBtn = el('clearBtn');
    const loadExampleBtn = el('loadExampleBtn');

    const analysisStatus = el('analysisStatus');
    const filesCount = el('filesCount');
    const additionsEl = el('additions');
    const deletionsEl = el('deletions');
    const guessedTypeEl = el('guessedType');
    const scopeChipsEl = el('scopeChips');
    const filesListEl = el('filesList');
    const toggleFilesBtn = el('toggleFilesBtn');

    const typeSelect = el('typeSelect');
    const scopeInput = el('scopeInput');
    const scopeSuggestions = el('scopeSuggestions');
    const descriptionInput = el('descriptionInput');
    const bodyInput = el('bodyInput');
    const footerInput = el('footerInput');

    const toggleBodyBtn = el('toggleBodyBtn');
    const toggleFooterBtn = el('toggleFooterBtn');

    const breakingCheck = el('breakingCheck');
    const breakingBox = el('breakingBox');
    const breakingInput = el('breakingInput');

    const preview = el('preview');
    const copyBtn = el('copyBtn');
    const copyStatus = el('copyStatus');

    const headerLint = el('headerLint');
    const diffHint = el('diffHint');

    let lastAnalysis = {
      files: [],
      additions: 0,
      deletions: 0,
      guessedType: 'chore',
      scopeCandidates: [],
      rawDiff: ''
    };

    function clampText(s, maxLen) {
      s = (s ?? '').toString();
      if (s.length <= maxLen) return s;
      return s.slice(0, maxLen - 1) + '…';
    }

    function escapeHTML(str) {
      return (str ?? '').toString()
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }

    function humanStatus(status) {
      switch(status) {
        case 'A': return { label: 'ADD', cls: 'bg-emerald-500/15 text-emerald-200 border-emerald-500/30' };
        case 'D': return { label: 'DEL', cls: 'bg-rose-500/15 text-rose-200 border-rose-500/30' };
        case 'R': return { label: 'REN', cls: 'bg-amber-500/15 text-amber-200 border-amber-500/30' };
        default: return { label: 'MOD', cls: 'bg-sky-500/15 text-sky-200 border-sky-500/30' };
      }
    }

    function normalizePath(p) {
      return (p ?? '').trim().replace(/^b\//, '').replace(/^a\//, '');
    }

    function parseDiff(text) {
      const lines = (text ?? '').replaceAll('\r\n', '\n').split('\n');
      const files = [];
      let current = null;
      let additions = 0;
      let deletions = 0;

      const startFile = (aPath, bPath) => {
        const file = {
          a: normalizePath(aPath),
          b: normalizePath(bPath),
          path: normalizePath(bPath) || normalizePath(aPath),
          status: 'M',
          additions: 0,
          deletions: 0,
          renamedFrom: null,
          renamedTo: null,
        };
        files.push(file);
        current = file;
      };

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        if (line.startsWith('diff --git ')) {
          const m = line.match(/^diff --git a\/(.+?) b\/(.+)$/);
          if (m) startFile(m[1], m[2]);
          else current = null;
          continue;
        }

        if (!current) continue;

        if (line.startsWith('new file mode ')) current.status = 'A';
        if (line.startsWith('deleted file mode ')) current.status = 'D';

        if (line.startsWith('rename from ')) {
          current.status = 'R';
          current.renamedFrom = line.slice('rename from '.length).trim();
        }
        if (line.startsWith('rename to ')) {
          current.status = 'R';
          current.renamedTo = line.slice('rename to '.length).trim();
          current.path = normalizePath(current.renamedTo);
        }

        if (line.startsWith('+++ ') || line.startsWith('--- ') || line.startsWith('@@')) continue;

        if (line.startsWith('+') && !line.startsWith('+++')) {
          additions++; current.additions++;
        } else if (line.startsWith('-') && !line.startsWith('---')) {
          deletions++; current.deletions++;
        }
      }

      // Deduplicate by path (some diffs can be weird). Keep first occurrence.
      const seen = new Set();
      const uniq = [];
      for (const f of files) {
        const key = f.path || f.b || f.a;
        if (!key) continue;
        if (!seen.has(key)) { seen.add(key); uniq.push(f); }
      }

      return { files: uniq, additions, deletions };
    }

    function classifyFiles(files) {
      const exts = files.map(f => (f.path.split('.').pop() || '').toLowerCase());
      const paths = files.map(f => (f.path || '').toLowerCase());

      const isDocs = (p) => {
        const base = p.split('/').pop() || '';
        return (
          p.startsWith('docs/') ||
          base === 'readme.md' || base.startsWith('readme') ||
          base.endsWith('.md') || base.endsWith('.mdx') || base.endsWith('.rst')
        );
      };
      const isTest = (p) => {
        const base = p.split('/').pop() || '';
        return (
          p.includes('/__tests__/') ||
          p.startsWith('test/') || p.startsWith('tests/') ||
          base.endsWith('.spec.ts') || base.endsWith('.spec.js') ||
          base.endsWith('.test.ts') || base.endsWith('.test.js')
        );
      };
      const isCI = (p) => (
        p.startsWith('.github/workflows/') ||
        p.includes('/.github/workflows/') ||
        p.startsWith('.circleci/') ||
        p === '.gitlab-ci.yml'
      );
      const isBuild = (p) => {
        const base = p.split('/').pop() || '';
        return (
          base === 'package.json' || base === 'package-lock.json' || base === 'yarn.lock' || base === 'pnpm-lock.yaml' ||
          base === 'tsconfig.json' || base === 'vite.config.ts' || base === 'vite.config.js' ||
          base === 'webpack.config.js' || base === 'rollup.config.js' ||
          base === 'makefile' || base === 'dockerfile' ||
          base.endsWith('.gradle')
        );
      };

      let docs = 0, test = 0, ci = 0, build = 0, code = 0;

      const codeExts = new Set(['js','ts','jsx','tsx','py','go','rs','java','kt','c','cc','cpp','h','hpp','cs','php','rb','swift','m','mm','scala']);

      for (const p of paths) {
        if (!p) continue;
        if (isDocs(p)) docs++;
        if (isTest(p)) test++;
        if (isCI(p)) ci++;
        if (isBuild(p)) build++;

        const ext = (p.split('.').pop() || '').toLowerCase();
        if (codeExts.has(ext) || p.startsWith('src/') || p.startsWith('lib/') || p.startsWith('app/')) code++;
      }

      return {
        total: files.length,
        docs, test, ci, build, code,
        docsOnly: files.length > 0 && docs === files.length,
        testOnly: files.length > 0 && test === files.length,
        ciOnly: files.length > 0 && ci === files.length,
        buildOnly: files.length > 0 && build === files.length,
      };
    }

    function guessTypeFromDiff(rawDiff, files, additions, deletions) {
      if (!rawDiff.trim()) return 'chore';
      const cls = classifyFiles(files);
      if (cls.docsOnly) return 'docs';
      if (cls.ciOnly) return 'ci';
      if (cls.testOnly) return 'test';
      if (cls.buildOnly) return 'build';

      const text = rawDiff.toLowerCase();
      const bugHints = /(fix|bug|issue|error|exception|crash|panic|regression|nullpointer|npe|undefined|segfault)/i;
      const perfHints = /(perf|performance|optimi[sz]e|fast(er)?|slow|latency|throughput)/i;
      const refactorHints = /(refactor|cleanup|restructure|rename|move|extract|inline)/i;
      const styleHints = /(prettier|eslint|format|lint)/i;

      if (bugHints.test(text)) return 'fix';
      if (perfHints.test(text)) return 'perf';
      if (styleHints.test(text) && cls.code > 0 && cls.build === 0) return 'style';
      if (refactorHints.test(text) || deletions > additions * 1.3) return 'refactor';

      // Default heuristic
      if (cls.code > 0) return 'feat';
      if (cls.build > 0) return 'build';
      return 'chore';
    }

    function collectScopeCandidates(files) {
      const ignore = new Set(['src','lib','app','packages','package','apps']);
      const counts = new Map();

      const add = (s) => {
        s = (s ?? '').trim();
        if (!s) return;
        if (s.length > 32) return;
        // conventional commit scope usually lowercase and simple
        const norm = s
          .replaceAll('\\', '/')
          .split('/')[0]
          .replaceAll(/[^a-z0-9._-]/gi, '')
          .toLowerCase();
        if (!norm) return;
        if (ignore.has(norm)) return;
        counts.set(norm, (counts.get(norm) ?? 0) + 1);
      };

      for (const f of files) {
        const p = (f.path ?? '').replaceAll('\\', '/');
        if (!p) continue;
        const parts = p.split('/').filter(Boolean);
        if (parts.length === 0) continue;

        // If first is generic, use second.
        if (ignore.has(parts[0].toLowerCase()) && parts[1]) add(parts[1]);
        else add(parts[0]);

        // Extra hint from filename (without ext) for single-file changes.
        const base = parts[parts.length - 1];
        const name = base.includes('.') ? base.slice(0, base.lastIndexOf('.')) : base;
        if (name && name.length >= 3 && name.length <= 20) add(name);

        // Special-case dependencies
        if (base === 'package.json' || base.endsWith('lock.json') || base === 'yarn.lock' || base === 'pnpm-lock.yaml') add('deps');
      }

      return [...counts.entries()]
        .sort((a,b) => b[1] - a[1])
        .map(([scope, count]) => ({ scope, count }));
    }

    function generateDescription(type, scopeCandidates, files, additions, deletions, rawDiff) {
      const cls = classifyFiles(files);
      const scope = (scopeCandidates?.[0]?.scope) || '';
      const many = files.length >= 6;

      const shortScope = scope ? ` ${scope}` : '';

      if (type === 'docs') return many ? 'update documentation' : 'update docs';
      if (type === 'ci') return 'update CI configuration';
      if (type === 'build') return cls.build > 0 ? 'update dependencies' : 'update build configuration';
      if (type === 'test') return scope ? `add tests for ${scope}` : 'improve test coverage';
      if (type === 'style') return scope ? `format${shortScope} code` : 'format code';
      if (type === 'refactor') return scope ? `refactor${shortScope}` : 'refactor code';
      if (type === 'perf') return scope ? `improve${shortScope} performance` : 'improve performance';
      if (type === 'fix') return scope ? `fix${shortScope} issues` : 'fix issues';
      if (type === 'revert') return 'revert previous changes';

      // feat/chore fallback
      const text = rawDiff.toLowerCase();
      if (/\badd\b|\bcreate\b|\bintroduce\b|\bnew\b/.test(text) && scope) return `add${shortScope} support`;
      if (scope) return `improve${shortScope}`;

      if (cls.code > 0 && additions >= deletions) return 'add new functionality';
      return 'update project files';
    }

    function renderAnalysis(analysis) {
      analysisStatus.textContent = analysis.files.length ? 'готово' : 'нет данных';
      filesCount.textContent = analysis.files.length ? String(analysis.files.length) : '—';
      additionsEl.textContent = `+${analysis.additions}`;
      deletionsEl.textContent = `-${analysis.deletions}`;
      guessedTypeEl.textContent = analysis.files.length ? analysis.guessedType : '—';

      // Files list
      if (!analysis.files.length) {
        filesListEl.innerHTML = '<p class="text-sm text-slate-400">Пока пусто — вставьте diff и нажмите «Проанализировать».</p>';
      } else {
        const rows = analysis.files.map(f => {
          const hs = humanStatus(f.status);
          const name = escapeHTML(f.path);
          const meta = [];
          if (f.additions || f.deletions) meta.push(`<span class="text-emerald-300">+${f.additions}</span> <span class="text-rose-300">-${f.deletions}</span>`);
          if (f.status === 'R' && (f.renamedFrom || f.renamedTo)) {
            meta.push(`<span class="text-slate-400">${escapeHTML(f.renamedFrom || '')} → ${escapeHTML(f.renamedTo || '')}</span>`);
          }
          return `
            <div class="flex items-start justify-between gap-3 py-2 border-b border-slate-800 last:border-b-0">
              <div class="min-w-0">
                <div class="flex items-center gap-2">
                  <span class="px-2 py-0.5 rounded-lg border text-xs mono ${hs.cls}">${hs.label}</span>
                  <span class="mono text-sm text-slate-100 truncate">${name}</span>
                </div>
                <div class="mt-1 text-xs mono">${meta.join(' · ')}</div>
              </div>
            </div>
          `;
        }).join('');
        filesListEl.innerHTML = rows;
      }

      // Scope chips summary
      if (!analysis.scopeCandidates.length) {
        scopeChipsEl.textContent = analysis.files.length ? '—' : '—';
      } else {
        scopeChipsEl.innerHTML = analysis.scopeCandidates.slice(0, 6).map(({scope, count}, idx) => {
          const strong = idx === 0 ? 'border-indigo-400/40 bg-indigo-500/10 text-indigo-200' : 'border-slate-700 bg-slate-900/40 text-slate-200';
          return `<span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-xl border ${strong}"><span class="mono">${escapeHTML(scope)}</span><span class="text-xs text-slate-400">${count}</span></span>`;
        }).join(' ');
      }
    }

    function refreshScopeSuggestions(scopeCandidates) {
      scopeSuggestions.innerHTML = '';
      if (!scopeCandidates?.length) return;
      const top = scopeCandidates.slice(0, 8);
      for (const item of top) {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'px-2.5 py-1.5 rounded-xl border border-slate-800 bg-slate-950/40 hover:bg-slate-800/50 text-slate-200 text-xs mono';
        b.textContent = item.scope;
        b.title = `Встречается в diff: ${item.count}`;
        b.addEventListener('click', () => {
          scopeInput.value = item.scope;
          updatePreview();
          scopeInput.focus();
        });
        scopeSuggestions.appendChild(b);
      }
    }

    function buildCommitMessage() {
      const type = typeSelect.value.trim();
      const scope = scopeInput.value.trim();
      const desc = descriptionInput.value.trim();
      const body = bodyInput.value.trim();
      const footer = footerInput.value.trim();
      const breaking = breakingCheck.checked;
      const breakingText = breakingInput.value.trim();

      const scopePart = scope ? `(${scope})` : '';
      const bang = breaking ? '!' : '';

      const safeDesc = desc || '(describe your change)';
      const header = `${type}${scopePart}${bang}: ${safeDesc}`;

      const parts = [header];
      if (body) parts.push('', body);

      if (breaking) {
        const bt = breakingText || 'describe breaking change';
        parts.push('', `BREAKING CHANGE: ${bt}`);
      }

      if (footer) parts.push('', footer);
      return parts.join('\n');
    }

    function updateHeaderLint(headerLine) {
      const len = headerLine.length;
      const ok = len <= 72;
      headerLint.innerHTML = ok
        ? `<span class="text-emerald-300">Заголовок: ${len} символов (ок)</span>`
        : `<span class="text-amber-300">Заголовок: ${len} символов (лучше сократить до 72)</span>`;
    }

    function updatePreview() {
      const msg = buildCommitMessage();
      preview.textContent = msg;
      updateHeaderLint(msg.split('\n')[0] || '');
    }

    function applyAnalysisToForm(analysis) {
      // Prefer guessed type
      if (analysis.guessedType) typeSelect.value = analysis.guessedType;

      // Suggest scope and description
      const candidates = analysis.scopeCandidates || [];
      refreshScopeSuggestions(candidates);

      if (!scopeInput.value.trim() && candidates[0]?.scope) {
        scopeInput.value = candidates[0].scope;
      }

      if (!descriptionInput.value.trim()) {
        descriptionInput.value = generateDescription(
          analysis.guessedType,
          candidates,
          analysis.files,
          analysis.additions,
          analysis.deletions,
          analysis.rawDiff
        );
      }

      // Breaking change hint
      const lower = (analysis.rawDiff || '').toLowerCase();
      const breakingHint = /breaking change|\bbreaking\b|remove(d)? |deprecated|drop support/i.test(lower);
      if (breakingHint && !breakingCheck.checked) {
        // Soft suggestion: do not auto-check, but show info.
        diffHint.textContent = 'В diff есть маркеры, похожие на breaking change — проверьте.';
      } else {
        diffHint.textContent = '';
      }

      updatePreview();
    }

    function analyzeNow() {
      const rawDiff = diffInput.value;
      const parsed = parseDiff(rawDiff);
      const scopeCandidates = collectScopeCandidates(parsed.files);
      const guessedType = guessTypeFromDiff(rawDiff, parsed.files, parsed.additions, parsed.deletions);

      lastAnalysis = {
        files: parsed.files,
        additions: parsed.additions,
        deletions: parsed.deletions,
        guessedType,
        scopeCandidates,
        rawDiff
      };

      renderAnalysis(lastAnalysis);
      applyAnalysisToForm(lastAnalysis);
    }

    function setFilesVisibility(visible) {
      filesListEl.classList.toggle('hidden', !visible);
      toggleFilesBtn.textContent = visible ? 'скрыть' : 'показать';
    }

    function setTextareaVisibility(textarea, btn, visibleLabel, hiddenLabel) {
      const visible = !textarea.classList.contains('hidden');
      const willShow = !visible;
      textarea.classList.toggle('hidden', !willShow);
      btn.textContent = willShow ? visibleLabel : hiddenLabel;
    }

    function resetAll() {
      diffInput.value = '';
      analysisStatus.textContent = 'ожидание';
      filesCount.textContent = '—';
      additionsEl.textContent = '+0';
      deletionsEl.textContent = '-0';
      guessedTypeEl.textContent = '—';
      scopeChipsEl.textContent = '—';
      filesListEl.innerHTML = '<p class="text-sm text-slate-400">Пока пусто — вставьте diff и нажмите «Проанализировать».</p>';
      diffHint.textContent = '';

      typeSelect.value = 'feat';
      scopeInput.value = '';
      descriptionInput.value = '';
      bodyInput.value = '';
      footerInput.value = '';
      breakingCheck.checked = false;
      breakingInput.value = '';
      breakingBox.classList.add('hidden');

      scopeSuggestions.innerHTML = '';
      setFilesVisibility(true);
      updatePreview();
    }

    async function copyPreview() {
      const msg = buildCommitMessage();
      try {
        await navigator.clipboard.writeText(msg);
        copyStatus.textContent = 'Скопировано в буфер обмена.';
      } catch (e) {
        // Fallback
        const ta = document.createElement('textarea');
        ta.value = msg;
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        try {
          document.execCommand('copy');
          copyStatus.textContent = 'Скопировано (fallback).';
        } catch (e2) {
          copyStatus.textContent = 'Не удалось скопировать. Выделите текст вручную.';
        } finally {
          document.body.removeChild(ta);
        }
      }
      setTimeout(() => (copyStatus.textContent = ''), 2000);
    }

    const EXAMPLE_DIFF = `diff --git a/src/auth/token.ts b/src/auth/token.ts\nindex 1a2b3c4..5d6e7f8 100644\n--- a/src/auth/token.ts\n+++ b/src/auth/token.ts\n@@ -1,10 +1,18 @@\n export function parseToken(input: string) {\n-  if (!input) throw new Error('Missing token')\n+  if (!input) throw new Error('Missing token')\n+\n+  // fix: handle extra whitespace\n+  const value = input.trim()\n+\n+  if (!value.includes('.')) {\n+    throw new Error('Invalid token format')\n+  }\n \n-  return input.split('.')\n+  return value.split('.')\n }\n\ndiff --git a/README.md b/README.md\nindex 2222222..3333333 100644\n--- a/README.md\n+++ b/README.md\n@@ -1,3 +1,5 @@\n # Example\n+\n+Document updated.\n`;

    // Events
    analyzeBtn.addEventListener('click', analyzeNow);
    clearBtn.addEventListener('click', resetAll);

    loadExampleBtn.addEventListener('click', () => {
      diffInput.value = EXAMPLE_DIFF;
      analyzeNow();
      diffInput.focus();
    });

    toggleFilesBtn.addEventListener('click', () => {
      const currentlyVisible = !filesListEl.classList.contains('hidden');
      setFilesVisibility(!currentlyVisible);
    });

    toggleBodyBtn.addEventListener('click', () => setTextareaVisibility(bodyInput, toggleBodyBtn, 'скрыть', 'показать'));
    toggleFooterBtn.addEventListener('click', () => setTextareaVisibility(footerInput, toggleFooterBtn, 'скрыть', 'показать'));

    breakingCheck.addEventListener('change', () => {
      breakingBox.classList.toggle('hidden', !breakingCheck.checked);
      updatePreview();
    });

    [typeSelect, scopeInput, descriptionInput, bodyInput, footerInput, breakingInput].forEach(node => {
      node.addEventListener('input', updatePreview);
      node.addEventListener('change', updatePreview);
    });

    copyBtn.addEventListener('click', copyPreview);

    // Shortcuts
    document.addEventListener('keydown', (e) => {
      const mod = e.ctrlKey || e.metaKey;
      if (mod && e.key === 'Enter') {
        e.preventDefault();
        analyzeNow();
      }
      if (mod && (e.key.toLowerCase() === 'k')) {
        e.preventDefault();
        resetAll();
      }
    });

    // Initial state
    resetAll();
  </script>
</body>
</html>
